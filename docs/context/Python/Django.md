[Django官方文档4.2 ](https://docs.djangoproject.com/zh-hans/4.2/)





# Django入门

Python的Web框架有上百个，比它的关键字还要多。所谓Web框架，就是用于开发Web服务器端应用的基础设施，说得通俗一点就是一系列封装好的模块和工具。事实上，即便没有Web框架，我们仍然可以通过socket或[CGI](https://zh.wikipedia.org/wiki/通用网关接口)来开发Web服务器端应用，但是这样做的成本和代价在商业项目中通常是不能接受的。通过Web框架，我们可以化繁为简，降低创建、更新、扩展应用程序的工作量。刚才我们说到Python有上百个Web框架，这些框架包括Django、Flask、Tornado、Sanic、Pyramid、Bottle、Web2py、web.py等。

对常用的设计和开发模式进行了封装，并对MVC架构提供了支持（Django中称之为MTV架构）。MVC是软件系统开发领域中一种放之四海而皆准的架构，它将系统中的组件分为模型（Model）、视图（View）和控制器（Controller）三个部分并借此实现模型（数据）和视图（显示）的解耦合。由于模型和视图进行了分离，所以需要一个中间人将解耦合的模型和视图联系起来，扮演这个角色的就是控制器。稍具规模的软件系统都会使用MVC架构（或者是从MVC演进出的其他架构），Django项目中我们称之为MTV，MTV中的M跟MVC中的M没有区别，就是代表数据的模型，T代表了网页模板（显示数据的视图），而V代表了视图函数，在Django框架中，视图函数和Django框架本身一起扮演了MVC中C的角色。

Django框架诞生于2003年，它是一个在真正的应用中成长起来的项目，由劳伦斯出版集团旗下在线新闻网站的内容管理系统（CMS）研发团队（主要是Adrian Holovaty和Simon Willison）开发，以比利时的吉普赛爵士吉他手Django Reinhardt来命名。Django框架在2005年夏天作为开源框架发布，使用Django框架能用很短的时间构建出功能完备的网站，因为它代替程序员完成了那些重复乏味的劳动，剩下真正有意义的核心业务给程序员来开发，这一点就是对DRY（Don't Repeat Yourself）理念的最好践行。许多成功的网站和应用都是基于Python语言进行开发的，国内比较有代表性的网站包括：知乎、豆瓣网、果壳网、搜狐闪电邮箱、101围棋网、海报时尚网、背书吧、堆糖、手机搜狐网、咕咚、爱福窝、果库等，其中不乏使用了Django框架的产品。



Django的**MVT**设计模式由**Model(模型)**, **View(视图)** 和**Template(模板)**三部分组成，分别对应单个app目录下的`models.py`, `views.py`和`templates`文件夹。它们看似与MVC设计模式不太一致，其实本质是相同的。Django的MVT设计模式与经典的MVC对应关系如下。

- **Django Model(模型)**: 这个与经典MVC模式下的**模型Model**差不多。
- **Django View(视图)**: 这个与MVC下的**控制器Controller**更像。视图不仅负责根据用户请求从数据库读取数据、指定向用户展示数据的方式(网页或json数据), 还可以指定渲染模板并处理用户提交的数据。
- **Django Template(模板)**: 这个与经典MVC模式下的**视图View**一致。模板用来呈现Django view传来的数据，也决定了用户界面的外观。Template里面也包含了表单，可以用来搜集用户的输入内容。



## Django初始配置



### Django安装

#### conda安装

以下代码要一个个输入Anaconda Prompt中，不可一次性粘贴

```shell
conda create -n Django42env python=3.9
activate Django42env
pip install django==4.2
```

1. `-n`为`--name`缩写，创建一个名为`Django42env`的虚拟环境，里面安装3.9版本的python，
2. 激活环境
3. 在激活的环境中安装Django4.2



 **验证Django安装**

```shell
python -m django --version
```


如果这行命令输出了一个版本号，证明你已经安装了此版本的 Django；如果你得到的是一个`No module named django`的错误提示，则表明你还未安装。



### Django项目文件

如果这是你**第一次**使用 Django 的话，你需要一些初始化设置。也就是说，你需要用一些自动生成的代码配置一个 Django project —— 即一个 Django 项目实例需要的设置项集合，包括数据库配置、Django 配置和应用程序配置。

打开命令行，`cd` 到一个你想放置你代码的目录，然后运行以下命令：

```shell
django-admin startproject mysite
```

**用Pycharm打开项目文件**

让我们看看 [`startproject`](https://docs.djangoproject.com/zh-hans/4.2/ref/django-admin/#django-admin-startproject) 创建了些什么：

```
mysite/
    manage.py
    mysite/
        __init__.py
        settings.py
        urls.py
        wsgi.py
        asgi.py
```

这些目录和文件的用处是：

- 最外层的 `mysite/` 根目录只是你项目的容器， 根目录名称对 Django 没有影响，你可以将它重命名为任何你喜欢的名称。
- `manage.py`: 一个让你用各种方式管理 Django 项目的命令行工具。
- 里面一层的 `mysite/` 目录包含你的项目，它是一个纯 Python 包。它的名字就是当你引用它内部任何东西时需要用到的 Python 包名。 (比如 `mysite.urls`).
- `mysite/__init__.py`：一个空文件，告诉 Python 这个目录应该被认为是一个 Python 包。
- `mysite/settings.py`：Django 项目的配置文件。
- `mysite/urls.py`：Django 项目的 URL 声明，就像你网站的“目录”。
- `mysite/wsgi.py`：作为你的项目的运行在 WSGI 兼容的Web服务器上的入口，Python服务器网关。
- `mysite/asgi.py`：作为你的项目的运行在 ASGI 兼容的 Web 服务器上的入口，与wsgi类似，实现了异步处理，用于启动异步通信服务。



**验证Django 项目是否创建成功**

如果你的当前目录不是外层的 `mysite` 目录的话，请切换到此目录，然后运行下面的命令：

```shell
python manage.py runserver 8000 
```

- Django自带的服务器只能用于**开发**和**测试**环境，因为这个服务器是纯Python编写的轻量级Web服务器，不适合在生产环境中使用。

- 如果修改了代码，**不需要**为了让修改的代码生效而重新启动Django自带的服务器。但是，在**添加**新的项目文件时，该服务器不会自动重新加载，这个时候就得手动重启服务器。



### 数据迁移

ORM(Object-relational mapping)，中文翻译为**对象关系映射**，是一种为了解决面向对象与**关系数据库**存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。

**迁移**：将模型映射到数据库

**生成迁移文件**

```shell
 python manage.py makemigrations
 python manage.py makemigrations polls
```

通过运行 `makemigrations` 命令，Django 会检测你对模型文件的修改（在这种情况下，你已经取得了新的），并且把修改的部分储存为一次 *迁移*。

迁移是 Django 对于模型定义（也就是你的数据库结构）的变化的储存形式 - 它们其实也只是一些你磁盘上的文件。如果你想的话，你可以阅读一下你模型的迁移数据，它被储存在 `polls/migrations/0001_initial.py` 里。别担心，你不需要每次都阅读迁移文件，但是它们被设计成人类可读的形式，这是为了便于你手动调整 Django 的修改方式。

Django 有一个自动执行数据库迁移并同步管理你的数据库结构的命令 - 这个命令是 [`migrate`](https://docs.djangoproject.com/zh-hans/4.2/ref/django-admin/#django-admin-migrate)，我们马上就会接触它 - 但是首先，让我们看看迁移命令会执行哪些 SQL 语句。[`sqlmigrate`](https://docs.djangoproject.com/zh-hans/4.2/ref/django-admin/#django-admin-sqlmigrate) 命令接收一个迁移的名称，然后返回对应的 SQL：

```shell
python manage.py sqlmigrate polls 0001
```

![image-20240705232242933](https://raw.githubusercontent.com/yzl-eng/blogImage/main/img/202407052322995.png)

请注意以下几点：

- 输出的内容和你使用的数据库有关，上面的输出示例使用的是。
- 数据库的表名是由应用名(`polls`)和模型名的小写形式( `question` 和 `choice`)连接而来。（如果需要，你可以自定义此行为。）
- 主键(IDs)会被自动创建。(当然，你也可以自定义。)
- 默认的，Django 会在外键字段名后追加字符串 `"_id"` 。（同样，这也可以自定义。）
- 外键关系由 `FOREIGN KEY` 生成。你不用关心 `DEFERRABLE` 部分，它只是告诉 PostgreSQL，请在事务全都执行完之后再创建外键关系。
- 它是为你正在使用的数据库定制的，因此特定于数据库的字段类型，例如`auto_increment`（MySQL）、`bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY`（PostgreSQL）或`integer primary key autoincrement ` (SQLite) 会自动为您处理。 字段名称的引用也是如此——例如，使用双引号或单引号。
- 这个 [`sqlmigrate`](https://docs.djangoproject.com/zh-hans/4.2/ref/django-admin/#django-admin-sqlmigrate) 命令并没有真正在你的数据库中的执行迁移 - 相反，它只是把命令输出到屏幕上，让你看看 Django 认为需要执行哪些 SQL 语句。这在你想看看 Django 到底准备做什么，或者当你是数据库管理员，需要写脚本来批量处理数据库时会很有用。

**执行迁移**

```shell
 python manage.py migrate
```





### 创建应用

如果要开发自己的Web应用，需要先在Django项目中创建“**应用**”，一个Django项目可以包含一个或多个应用。

```
python manage.py startapp polls
```

目录结构如下所示：

![image-20240705211525274](https://raw.githubusercontent.com/yzl-eng/blogImage/main/img/202407052115361.png)

- `migrations`：存放与模型有关的数据库迁移信息。
  - `__init__.py`：一个空文件，告诉Python解释器这个目录应该被视为一个Python的包。

- `__init__.py`：一个空文件，告诉Python解释器这个目录应该被视为一个Python的包。

- `admin.py`：可以用来注册模型，用于在Django框架自带的管理后台中管理模型。

- `apps.py`：当前应用的配置文件。

- `models.py`：存放应用的数据模型（MTV中的M）。

- `tests.py`：包含测试应用各项功能的测试类和测试函数。

- `views.py`：处理用户HTTP请求并返回HTTP响应的函数或类（MTV中的V）。

  

1. 修改应用目录下的视图文件`views.py`。

   ```python
   from django.http import HttpResponse
   
   def index(request):
       return HttpResponse("Hello, world. You're at the polls index.")
   ```

   

2. 修改Django项目目录下的`urls.py`文件，将视图函数和用户在浏览器中请求的路径对应。

   ```python
   from django.contrib import admin
   from django.urls import include, path
   
   urlpatterns = [
       path("polls/", include("polls.urls")),
       path("admin/", admin.site.urls),
   ]
   ```



### Admin后台管理

**创建一个管理员账号**

首先，我们得创建一个能登录管理页面的用户。请运行下面的命令：

```shell
python manage.py createsuperuser
```

键入你想要使用的用户名，然后按下回车键：

```shell
Username: admin
```

然后提示你输入想要使用的邮件地址：

```shell
Email address: admin@example.com
```

最后一步是输入密码。你会被要求输入两次密码，第二次的目的是为了确认第一次输入的确实是你想要的密码。





## Django相关设置更改

### 中文本地化设置



#### 中文Admin后台

后台管理界面改为**中文**，需将`settings.py`文件中的`LANGUAGE_CODE`值改为如下所示


> LANGUAGE_CODE = "zh-hans"



#### 中国时区

导入`pytz`模块：

> import pytz

在`settings.py`文件中找到`TIME_ZONE`设置项，并将其设置为希望使用的时区

> TIME_ZONE = 'Asia/Shanghai'

确保`USE_TZ`设置为`True`，以启用时区支持：

> USE_TZ = True

这将告诉Django使用设置的时区进行时间处理

`USE_TZ = True`的作用：

1. 前端传递过来的`DateFiled`类型，经过模型类，存到数据库中，全部是**0时区**时间。
2. 后端自己写的代码，只要是使用timezone获取的时间（已知的时间）（带时区的时间），django会**自己转换**，无需我们手动转换。
3. 模板显示问题：django模板，会将数据库中0时区的时间转换成当地时间，无需我们自己转换。

完成上述步骤后，Django将使用指定的时区进行日期和时间操作。请确保在修改时区设置后重新启动Django应用程序以使更改生效。



### 数据库设置

#### MySQL

安装第三方库**mysqlclient**

Django项目中操作MySQL，官方推荐`mysqlclient`这个库。

```
pip install mysqlclient
```

修改配置文件`settings.py`

修改项目文件夹里的`settings.py`的文件，添加创建的数据库和用户信息。

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',   # 数据库引擎
        'NAME': 'mydb',         # 数据库名，Django不会帮你创建，需要自己进入数据库创建。
        'USER': 'myuser',       # 设置的数据库用户名
        'PASSWORD': 'mypass',   # 设置的密码
        'HOST': 'localhost',    # 本地主机或数据库服务器的ip
        'PORT': '3306',         # 数据库使用的端口
    }
}
```

另一种设置方式是使用`OPTIONS`和配置文件`my.cnf`进行设置。

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'OPTIONS': {
            'read_default_file': '/path/to/my.cnf',
        },
    }
}
```

```shell
# my.cnf
[client]
database = mydb
user = myuser
password = mypass
default-character-set = utf8
```

设置好后，连续使用如下命令如果没有出现错误，那么恭喜你已经在Django项目中使用MySQL数据库啦。

```
python manage.py makemigrations                                                              
python manage.py migrate
```



#### PostgreSQL

安装第三方库[psycopg2](https://www.psycopg.org/)

- [ ] 似乎这个库版本有些落后，需核对一下

Django项目中操作PostgreSQL，官方推荐psycopg2 这个库。

```shell
pip install psycopg2
```

修改项目文件夹里的`settings.py`的文件，添加创建的数据库和用户信息。

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',   # 数据库引擎
        'NAME': 'mydb',         # 数据库名，Django不会帮你创建，需要自己进入数据库创建。
        'USER': 'myuser',     # 设置的数据库用户名
        'PASSWORD': 'mypass',     # 设置的密码
        'HOST': 'localhost',    # 本地主机或数据库服务器的ip
        'PORT': '',         # 数据库使用的端口
    }
}
```

设置好后，连续使用如下命令如果没有出现错误，那么恭喜你已经在Django项目中使用PostgreSQL数据库啦。

```shell
python manage.py makemigrations                                                              
python manage.py migrate
```







# Django路由





# Django模板

